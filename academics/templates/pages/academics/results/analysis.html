{% extends "base/admin_d.html" %}
{% load static %}

{% block title %}Results Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/pages/results.css' %}">
{% endblock %}

{% block content %}
<main class="main-content">
    <div class="page-header">
        <div class="header-top">
            <div class="page-title">
                <span class="icon"><i class="bi bi-graph-up-arrow"></i></span>
                <div>
                    <h1>Results Analysis</h1>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 4px;">
                        Comprehensive analytics and insights into academic performance
                    </p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{% url 'results_dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Results
                </a>
                <button class="btn btn-outline" id="refreshDataBtn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="exportDropdownBtn">
                        <i class="bi bi-download"></i> Export Report
                    </button>
                    <div class="dropdown-menu">
                        <button class="dropdown-item export-option" data-format="pdf">
                            <i class="bi bi-file-pdf"></i> Export as PDF
                        </button>
                        <button class="dropdown-item export-option" data-format="excel">
                            <i class="bi bi-file-spreadsheet"></i> Export as Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="filters-card">
        <h3><i class="bi bi-funnel"></i> Analysis Filters</h3>
        <form method="get" class="filters-form">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Academic Year</label>
                    <select name="academic_year" class="form-control">
                        <option value="">All Years</option>
                        {% for year in context.academic_years %}
                        <option value="{{ year.id }}" {% if context.current_filters.academic_year_id == year.id|stringformat:"s" %}selected{% endif %}>
                            {{ year.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Class Level</label>
                    <select name="class_level" class="form-control">
                        <option value="">All Classes</option>
                        {% for class in context.class_levels %}
                        <option value="{{ class.id }}" {% if context.current_filters.class_level_id == class.id|stringformat:"s" %}selected{% endif %}>
                            {{ class.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Term</label>
                    <select name="term" class="form-control">
                        <option value="">All Terms</option>
                        {% for term in context.terms %}
                        <option value="{{ term.id }}" {% if context.current_filters.term_id == term.id|stringformat:"s" %}selected{% endif %}>
                            {{ term.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i> Apply Filters
                    </button>
                    <a href="{% url 'results_analysis' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Overview Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #dbeafe;">
                <i class="bi bi-bar-chart" style="color: #2563eb;"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ context.total_results_analyzed }}</div>
                <div class="stat-label">Results Analyzed</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #d1fae5;">
                <i class="bi bi-graph-up" style="color: #10b981;"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">
                    {% with context.class_performance.0.avg_score as top_score %}
                    {{ top_score|default:0|floatformat:1 }}%
                    {% endwith %}
                </div>
                <div class="stat-label">Top Class Average</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #fef3c7;">
                <i class="bi bi-award" style="color: #f59e0b;"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">
                    {% with context.top_performers.0.score as top_score %}
                    {{ top_score|default:0|floatformat:1 }}%
                    {% endwith %}
                </div>
                <div class="stat-label">Highest Score</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #ede9fe;">
                <i class="bi bi-people" style="color: #8b5cf6;"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">
                    {% with context.class_performance|length as class_count %}
                    {{ class_count }}
                    {% endwith %}
                </div>
                <div class="stat-label">Classes Analyzed</div>
            </div>
        </div>
    </div>

    <div class="analysis-grid">
        <div class="analysis-card">
            <h4>Grade Distribution</h4>
            <div class="chart-container">
                <canvas id="gradeDistributionChart"></canvas>
            </div>
        </div>

        <div class="analysis-card">
            <h4>Subject Performance Radar</h4>
            <div class="chart-container">
                <canvas id="subjectPerformanceChart"></canvas>
            </div>
        </div>

        <div class="analysis-card">
            <h4>Class Performance Comparison</h4>
            <div class="chart-container">
                <canvas id="classPerformanceChart"></canvas>
            </div>
        </div>

        <div class="analysis-card">
            <h4>Performance Trends</h4>
            <div class="chart-container">
                <canvas id="performanceTrendsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="content-grid" style="margin-top: 24px;">
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-trophy"></i> Top Performers</h3>
            </div>
            <div class="card-body">
                {% if context.top_performers %}
                <div class="performance-list">
                    {% for result in context.top_performers %}
                    <div class="performance-item">
                        <div class="subject-info">
                            <strong>{{ result.student.get_full_name }}</strong>
                            <small>{{ result.subject.name }}</small>
                        </div>
                        <div class="performance-stats">
                            <div class="stat">
                                <span class="value">{{ result.score }}%</span>
                                <span class="label">Score</span>
                            </div>
                            <div class="stat">
                                <span class="value">{{ result.grade }}</span>
                                <span class="label">Grade</span>
                            </div>
                        </div>
                        <div class="performance-bar">
                            <div class="bar-fill" style="width: {{ result.score }}%;"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-trophy"></i>
                    <h4>No Performance Data</h4>
                    <p>No top performers data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-bar-chart"></i> Class Performance</h3>
            </div>
            <div class="card-body">
                {% if context.class_performance %}
                <div class="table-responsive">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Avg Score</th>
                                <th>Students</th>
                                <th>Pass Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for class in context.class_performance %}
                            <tr>
                                <td>
                                    <strong>{{ class.class_level__name }}</strong>
                                </td>
                                <td>
                                    <span class="score-badge">{{ class.avg_score|floatformat:1 }}%</span>
                                </td>
                                <td>{{ class.total_students }}</td>
                                <td>
                                    <span class="{% if class.pass_rate >= 80 %}grade-badge grade-a{% elif class.pass_rate >= 60 %}grade-badge grade-b{% else %}grade-badge grade-c{% endif %}">
                                        {{ class.pass_rate|floatformat:1 }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-bar-chart"></i>
                    <h4>No Class Data</h4>
                    <p>No class performance data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 24px;">
        <div class="card-header">
            <h3><i class="bi bi-pie-chart"></i> Grade Distribution Details</h3>
        </div>
        <div class="card-body">
            {% if context.grade_distribution %}
            <div class="table-responsive">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Grade</th>
                            <th>Count</th>
                            <th>Percentage</th>
                            <th>Score Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in context.grade_distribution %}
                        <tr>
                            <td>
                                <span class="grade-badge grade-{{ grade.grade|lower }}">
                                    {{ grade.grade }}
                                </span>
                            </td>
                            <td>{{ grade.count }}</td>
                            <td>
                                {% widthratio grade.count context.total_results_analyzed 100 %}%
                            </td>
                            <td>
                                {% if grade.grade == "A+" %}90-100
                                {% elif grade.grade == "A" %}80-89
                                {% elif grade.grade == "B+" %}75-79
                                {% elif grade.grade == "B" %}70-74
                                {% elif grade.grade == "C+" %}65-69
                                {% elif grade.grade == "C" %}60-64
                                {% elif grade.grade == "D+" %}55-59
                                {% elif grade.grade == "D" %}50-54
                                {% elif grade.grade == "E" %}35-49
                                {% else %}0-34
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-pie-chart"></i>
                <h4>No Grade Data</h4>
                <p>No grade distribution data available</p>
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="{% static 'scripts/JS/results_analysis.js' %}"></script>
<script>
    const analysisData = {
        gradeDistribution: {{ context.grade_distribution|safe }},
        subjectPerformance: {{ context.subject_performance|safe }},
        classPerformance: {{ context.class_performance|safe }},
        performanceTrends: {{ context.performance_trends|safe }}
    };

    window.analysisData = analysisData;
</script>
{% endblock %}