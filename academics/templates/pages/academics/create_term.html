{% extends 'base/admin_d.html' %}
{% load static %}

{% block title %}Create Term{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/pages/create_term.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4 main-content">
    <div class="row">
        <div class="col-12">
            <div class="card term-form">
                <div class="card-header">
                    <h4 class="card-title">Create New Term</h4>
                    <p class="card-subtitle">Create a new academic term within an academic year</p>
                </div>
                <div class="card-body">
                    <form id="createTermForm" method="POST">
                        {% csrf_token %}
                        
                        <div class="form-section">
                            <h5 class="form-section-title">Basic Information</h5>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="academic_year">Academic Year *</label>
                                    <select class="form-control" id="academic_year" name="academic_year" required>
                                        <option value="">Select Academic Year</option>
                                        {% for year in academic_years %}
                                        <option value="{{ year.id }}" 
                                                data-start="{{ year.start_date|date:'Y-m-d' }}"
                                                data-end="{{ year.end_date|date:'Y-m-d' }}">
                                            {{ year.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="name">Term Name *</label>
                                    <select class="form-control" id="name" name="name" required>
                                        <option value="">Select Term</option>
                                        <option value="1st Term">First Term</option>
                                        <option value="2nd Term">Second Term</option>
                                        <option value="3rd Term">Third Term</option>
                                    </select>
                                    <small class="form-text">Select the term name</small>
                                </div>
                            </div>

                            <div class="date-input-group">
                                <div class="form-group">
                                    <label for="start_date">Start Date *</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                                    <small class="form-text" id="start_date_help"></small>
                                </div>
                                <div class="form-group">
                                    <label for="end_date">End Date *</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                                    <small class="form-text" id="end_date_help"></small>
                                </div>
                            </div>
                            
                            <div class="date-range-info" id="dateRangeInfo" style="display: none;">
                                <i class="bi bi-info-circle"></i>
                                <span id="dateRangeText"></span>
                            </div>
                        </div>

                        <div class="form-section">
                            <h5 class="form-section-title">Term Settings</h5>
                            
                            <div class="checkbox-container" id="currentTermContainer">
                                <input type="checkbox" class="form-check-input" id="is_current" name="is_current">
                                <label class="form-check-label" for="is_current">
                                    Set as current term
                                </label>
                            </div>
                            <small class="form-text">
                                If checked, this will become the current term and any previous current term will be unset.
                            </small>
                        </div>

                        <div class="form-actions" style="margin-top: 32px;">
                            <a href="{% url 'terms_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i>
                                Back to Terms
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i>
                                Create Term
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize checkbox container
    const checkbox = document.getElementById('is_current');
    const container = document.getElementById('currentTermContainer');
    
    container.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox') {
            checkbox.checked = !checkbox.checked;
            updateCheckboxStyle();
        }
    });
    
    function updateCheckboxStyle() {
        container.classList.toggle('checked', checkbox.checked);
    }
    updateCheckboxStyle();

    // Academic year change handler
    document.getElementById('academic_year').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const startDate = selectedOption.getAttribute('data-start');
        const endDate = selectedOption.getAttribute('data-end');
        
        const startDateField = document.getElementById('start_date');
        const endDateField = document.getElementById('end_date');
        const dateRangeInfo = document.getElementById('dateRangeInfo');
        const dateRangeText = document.getElementById('dateRangeText');
        
        if (startDate && endDate) {
            // Set min/max dates based on academic year
            startDateField.min = startDate;
            startDateField.max = endDate;
            endDateField.min = startDate;
            endDateField.max = endDate;
            
            // Update help text
            document.getElementById('start_date_help').textContent = 
                `Must be between ${formatDate(startDate)} and ${formatDate(endDate)}`;
            document.getElementById('end_date_help').textContent = 
                `Must be between ${formatDate(startDate)} and ${formatDate(endDate)}`;
            
            // Show date range info
            dateRangeText.textContent = 
                `Academic Year: ${formatDate(startDate)} to ${formatDate(endDate)}`;
            dateRangeInfo.style.display = 'block';
            
            // Auto-fill dates based on term name if academic year changes
            autoFillDates();
        } else {
            dateRangeInfo.style.display = 'none';
            startDateField.min = '';
            startDateField.max = '';
            endDateField.min = '';
            endDateField.max = '';
        }
    });

    // Term name change handler
    document.getElementById('name').addEventListener('change', function() {
        autoFillDates();
    });

    function autoFillDates() {
        const academicYearSelect = document.getElementById('academic_year');
        const termNameSelect = document.getElementById('name');
        const startDateField = document.getElementById('start_date');
        const endDateField = document.getElementById('end_date');
        
        const selectedYear = academicYearSelect.options[academicYearSelect.selectedIndex];
        const termName = termNameSelect.value;
        
        if (!selectedYear.value || !termName) return;
        
        const yearStart = new Date(selectedYear.getAttribute('data-start'));
        const yearEnd = new Date(selectedYear.getAttribute('data-end'));
        const yearDuration = yearEnd - yearStart;
        
        let termStart, termEnd;
        
        switch(termName) {
            case '1st Term':
                termStart = new Date(yearStart);
                termEnd = new Date(yearStart.getTime() + (yearDuration * 0.33));
                break;
            case '2nd Term':
                termStart = new Date(yearStart.getTime() + (yearDuration * 0.33));
                termEnd = new Date(yearStart.getTime() + (yearDuration * 0.66));
                break;
            case '3rd Term':
                termStart = new Date(yearStart.getTime() + (yearDuration * 0.66));
                termEnd = new Date(yearEnd);
                break;
            default:
                return;
        }
        
        // Only auto-fill if dates are empty
        if (!startDateField.value) {
            startDateField.value = formatDateForInput(termStart);
        }
        if (!endDateField.value) {
            endDateField.value = formatDateForInput(termEnd);
        }
    }

    // Date validation
    document.getElementById('start_date').addEventListener('change', function() {
        const endDateField = document.getElementById('end_date');
        const academicYearSelect = document.getElementById('academic_year');
        const selectedYear = academicYearSelect.options[academicYearSelect.selectedIndex];
        
        if (this.value && selectedYear.value) {
            const yearStart = selectedYear.getAttribute('data-start');
            const yearEnd = selectedYear.getAttribute('data-end');
            const startDate = new Date(this.value);
            const academicStart = new Date(yearStart);
            const academicEnd = new Date(yearEnd);
            
            // Validate against academic year bounds
            if (startDate < academicStart || startDate > academicEnd) {
                showToast(`Start date must be within the academic year range: ${formatDate(yearStart)} to ${formatDate(yearEnd)}`, 'error');
                this.value = '';
                return;
            }
            
            // Set minimum end date
            endDateField.min = this.value;
            
            // Auto-adjust end date if it's before start date
            if (endDateField.value && new Date(endDateField.value) < startDate) {
                endDateField.value = '';
            }
        }
    });

    document.getElementById('end_date').addEventListener('change', function() {
        const startDateField = document.getElementById('start_date');
        const academicYearSelect = document.getElementById('academic_year');
        const selectedYear = academicYearSelect.options[academicYearSelect.selectedIndex];
        
        if (this.value && startDateField.value && selectedYear.value) {
            const startDate = new Date(startDateField.value);
            const endDate = new Date(this.value);
            const yearEnd = new Date(selectedYear.getAttribute('data-end'));
            
            // Validate against academic year bounds
            if (endDate > yearEnd) {
                showToast(`End date cannot exceed academic year end date: ${formatDate(selectedYear.getAttribute('data-end'))}`, 'error');
                this.value = '';
                return;
            }
            
            if (endDate <= startDate) {
                showToast('End date must be after start date', 'error');
                this.value = '';
            }
        }
    });

    // Form submission
    document.getElementById('createTermForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
            this.classList.add('loading');
            
            const response = await fetch('{% url "create_term" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                if (typeof showToast === 'function') {
                    showToast(data.message, 'success');
                } else {
                    alert('Success: ' + data.message);
                }
                
                submitBtn.classList.add('success-pulse');
                
                setTimeout(() => {
                    {% if request.GET.next %}
                        window.location.href = '{{ request.GET.next }}';
                    {% else %}
                        window.location.href = '{% url "terms_list" %}';
                    {% endif %}
                }, 1500);
                
            } else {
                const errorMessage = data.error || 'Failed to create term';
                if (typeof showToast === 'function') {
                    showToast(errorMessage, 'error');
                } else {
                    alert('Error: ' + errorMessage);
                }
            }
            
        } catch (error) {
            console.error('Error creating term:', error);
            const errorMessage = 'Network error occurred. Please check your connection and try again.';
            
            if (typeof showToast === 'function') {
                showToast(errorMessage, 'error');
            } else {
                alert('Error: ' + errorMessage);
            }
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            this.classList.remove('loading');
            submitBtn.classList.remove('success-pulse');
        }
    });

    // Utility functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }

    function formatDateForInput(date) {
        return date.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}