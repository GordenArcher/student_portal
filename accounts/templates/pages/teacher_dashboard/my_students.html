{% extends "base/teacher_d.html" %}
{% load static %}

{% block title %}My Students - Teacher Portal{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'styles/pages/students_management.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="main-content">
    <div class="content-header">
        <div class="header-content">
            <h1>üë®‚Äçüéì My Students</h1>
            <p>Students in your classes</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline-primary" id="exportStudents">
                <i class="bi bi-download"></i> Export List
            </button>
        </div>
    </div>

    <div class="filters-card">
        <form method="get" class="filters-form">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Filter by Class</label>
                    <select name="class" class="form-control" onchange="this.form.submit()">
                        <option value="">All Classes</option>
                        {% for class in classes_taught %}
                        <option value="{{ class.id }}" {% if current_class_filter == class.id|stringformat:"s" %}selected{% endif %}>
                            {{ class.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <a href="{% url 'my_students' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <div class="students-grid">
        {% for student in students %}
        <div class="student-card">
            <div class="student-header">
                <div class="student-avatar">
                    {% if student.user.profile_picture %}
                        <img src="{{ student.user.profile_picture.url }}" alt="{{ student.user.get_full_name }}">
                    {% else %}
                        <i class="bi bi-person-circle"></i>
                    {% endif %}
                </div>
                <div class="student-info">
                    <h3>{{ student.user.get_full_name }}</h3>
                    <span class="student-id">{{ student.student_id }}</span>
                </div>
            </div>
            
            <div class="student-details">
                <div class="detail-item">
                    <i class="bi bi-building"></i>
                    <span>{{ student.current_class.name }}</span>
                </div>

                <div class="detail-item">
                    <i class="bi bi-telephone"></i>
                    <span>Parent Phone: {{ student.parent_phone|default:"No phone" }}</span>
                </div>
                
                <div class="detail-item">
                    <i class="bi bi-envelope"></i>
                    <span>Parent Email: {{ student.parent_email|default:"No email" }}</span>
                </div>

            </div>
            
            <div class="student-stats">
                <div class="stat">
                    <small>Average Score</small>
                    <!--  -->
                </div>
                <div class="stat">
                    <small>Results</small>
                    <strong>{{ student.result_set.count }}</strong>
                </div>
            </div>
            
            <div class="student-actions">
                <button class="btn btn-outline-primary btn-sm view-results" 
                        data-student-id="{{ student.id }}"
                        data-student-name="{{ student.user.get_full_name }}">
                    <i class="bi bi-journal-text"></i> Results
                </button>
                <a href="{% url 'manage_results' %}?student={{ student.id }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> Add Result
                </a>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="bi bi-people-slash"></i>
            <h4>No Students Found</h4>
            <p>
                {% if current_class_filter %}
                    No students found in the selected class.
                {% else %}
                    You don't have any students in your classes yet.
                {% endif %}
            </p>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalTitle">Student Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultsModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/students_management.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    initializeStudentsPage();
});

function initializeStudentsPage() {
    // View results buttons
    document.querySelectorAll('.view-results').forEach(btn => {
        btn.addEventListener('click', function() {
            const studentId = this.getAttribute('data-student-id');
            const studentName = this.getAttribute('data-student-name');
            viewStudentResults(studentId, studentName);
        });
    });

    // Export students button
    document.getElementById('exportStudents').addEventListener('click', exportStudentsList);
}

function viewStudentResults(studentId, studentName) {
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const modalTitle = document.getElementById('resultsModalTitle');
    const modalBody = document.getElementById('resultsModalBody');
    
    // Set modal title
    modalTitle.textContent = `Results - ${studentName}`;
    
    // Show loading spinner
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading student results...</p>
        </div>
    `;
    
    // Show modal
    modal.show();
    
    // Fetch student results
    fetch(`/api/students/${studentId}/results/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayStudentResults(modalBody, data.results, studentName);
            } else {
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Error loading results: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching student results:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Failed to load student results. Please try again.
                </div>
            `;
        });
}

function displayStudentResults(container, results, studentName) {
    if (results.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-journal-x"></i>
                <h5>No Results Found</h5>
                <p class="text-muted">No results available for ${studentName} yet.</p>
                <a href="{% url 'manage_results' %}?student=${studentId}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> Add First Result
                </a>
            </div>
        `;
        return;
    }

    let html = `
        <div class="results-summary mb-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Average Score</h6>
                            <h3 class="text-primary">${calculateAverage(results)}%</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Total Results</h6>
                            <h3 class="text-primary">${results.length}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">Best Subject</h6>
                            <h3 class="text-success">${getBestSubject(results)}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Term</th>
                        <th>Class Score</th>
                        <th>Exam Score</th>
                        <th>Total Score</th>
                        <th>Grade</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
    `;

    results.forEach(result => {
        html += `
            <tr>
                <td>${result.subject_name}</td>
                <td>${result.term_name}</td>
                <td>${result.class_score || '-'}</td>
                <td>${result.exam_score || '-'}</td>
                <td><strong>${result.score}%</strong></td>
                <td><span class="badge bg-${getGradeColor(result.grade)}">${result.grade}</span></td>
                <td>${new Date(result.date_uploaded).toLocaleDateString()}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = html;
}

function calculateAverage(results) {
    if (results.length === 0) return 0;
    const total = results.reduce((sum, result) => sum + parseFloat(result.score), 0);
    return (total / results.length).toFixed(1);
}

function getBestSubject(results) {
    if (results.length === 0) return '-';
    const bestResult = results.reduce((best, current) => 
        parseFloat(current.score) > parseFloat(best.score) ? current : best
    );
    return bestResult.subject_name;
}

function getGradeColor(grade) {
    const gradeColors = {
        'A+': 'success',
        'A': 'success',
        'B+': 'primary',
        'B': 'primary',
        'C+': 'warning',
        'C': 'warning',
        'D+': 'secondary',
        'D': 'secondary',
        'E': 'danger',
        'F': 'danger'
    };
    return gradeColors[grade] || 'secondary';
}

function exportStudentsList() {
    // Simple CSV export implementation
    const students = document.querySelectorAll('.student-card');
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Student Name,Student ID,Class,Parent Phone,Parent Email,Results Count\n";
    
    students.forEach(card => {
        const name = card.querySelector('.student-info h3').textContent;
        const id = card.querySelector('.student-id').textContent;
        const className = card.querySelector('.detail-item span').textContent;
        const phone = card.querySelectorAll('.detail-item')[1]?.querySelector('span')?.textContent.replace('Parent Phone: ', '') || 'N/A';
        const email = card.querySelectorAll('.detail-item')[2]?.querySelector('span')?.textContent.replace('Parent Email: ', '') || 'N/A';
        const resultsCount = card.querySelector('.stat strong').textContent;
        
        csvContent += `"${name}","${id}","${className}","${phone}","${email}","${resultsCount}"\n`;
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "my_students.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}